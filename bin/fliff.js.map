{"version":3,"sources":["../lib/fliff.js"],"names":["copy","require","ConfigRequiredIdSecretOrName","prompt","error","EOL","input","help","FailedToRetrieveIdUsingName","FailedToRetrieveNameUsingId","UpdateRequiredIdOrName","warn","FLIFF","ErrorMessages","init","initPath","fbjsonPath","path","resolve","distPath","basename","errMakeDir","code","console","log","process","exit","__dirname","junk","dot","filter","errCopy","rsCopy","info","sort","a","b","dest","forEach","file","verbose","fbjson","hosting","public","message","start","get","name","validator","default","errPrompt","rsPrompt","indexOf","installNow","toLowerCase","cmdInstall","cwd","stderr","on","data","toString","constructor","config","options","result","id","secret","token","Promise","reject","FLIFFError","FunctionsConfig","SingleChannelGroup","set","ChannelIdName","errId","ChannelSecretName","errSecret","AccessTokenName","errToken","update","req","LIFFUpdateRequest","accessToken","AccessToken","LIFFConfig","getViewIdByName","getViewNameById","type","url","view","description","ble","features","send","response"],"mappings":"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","sourcesContent":["import { spawn } from 'child_process';\nimport { mkdir, existsSync } from 'fs';\nimport { EOL } from 'os';\nimport * as path from 'path';\nimport * as prompt from 'prompt';\nimport './colors-set-theme';\nimport { FunctionsConfig } from './functions-config';\nimport { LIFFConfig } from './liff-config';\nimport { LIFFUpdateRequest } from './liff-update-request';\nimport { FLIFFError } from './fliff-error';\n\nconst copy = require('recursive-copy');\n\nconst ConfigRequiredIdSecretOrName = `Failed to configure channel. ${'fliff config'.prompt} required id, secret or token options.`.error + EOL +\n    `Try re-run with option ${'--id <channelId>'.input} OR ${'--secret <channelSecret>'.input} OR ${'--token <channelToken>'.input}`.help;\nconst FailedToRetrieveIdUsingName = `Failed to retrieve LIFF ID using view name`.error;\nconst FailedToRetrieveNameUsingId = `Failed to retrieve view name using LIFF ID`.error;\nconst UpdateRequiredIdOrName = `Command ${'fliff update'.prompt} required LIFF ID or name option`.warn + EOL +\n    `Try re-run with option ${'--id <liffId>'.input} OR ${'--name <viewName>'.input}`.help;\n\nexport class FLIFF {\n\n    static get ErrorMessages() {\n        return {\n            ConfigRequiredIdSecretOrName,\n            FailedToRetrieveIdUsingName,\n            FailedToRetrieveNameUsingId,\n            UpdateRequiredIdOrName\n        };\n    }\n\n    static init(initPath) {\n        const fbjsonPath = path.resolve(initPath, '../firebase.json');\n        const distPath = `${path.basename(initPath)}/dist`;\n\n        mkdir(initPath, errMakeDir => {\n            if (errMakeDir) {\n                switch (errMakeDir.code) {\n                    case 'EEXIST':\n                        console.log(`${initPath} already exists`.error);\n                        console.log(`Please manually delete ${initPath} and try again`.help);\n                        break;\n                    default: console.error(errMakeDir);\n                }\n                process.exit(1);\n            }\n\n            copy(path.resolve(__dirname, '../templates/web-views'), initPath, {\n                junk: false,\n                dot: true,\n                filter: [\n                    '*',\n                    'src/**/*',\n                    '!.cache',\n                    '!package-lock.json',\n                    '!dist',\n                    '!node_modules'\n                ]\n            }, (errCopy, rsCopy) => {\n                if (errCopy) {\n                    console.error(errMakeDir);\n                    process.exit(1);\n                }\n\n                console.log('Generated files'.info);\n                rsCopy.sort((a, b) => (a.dest > b.dest) ? 1 : ((b.dest > a.dest) ? -1 : 0));\n                rsCopy.forEach(file => console.log(file.dest.verbose));\n\n                if (existsSync(fbjsonPath)) {\n                    const fbjson = require(fbjsonPath);\n\n                    if (fbjson.hosting && fbjson.hosting.public !== distPath) {\n                        console.log(`firebase.json currently set hosting.public to ${fbjson.hosting.public.error}`.warn);\n                        console.log(`Please change hosting.public to ${distPath.info}`.warn);\n                    }\n                }\n\n                prompt.message = ''; // Workaround: Remove annoying prompt: prefix\n                prompt.start();\n                prompt.get([{\n                    name: 'installNow',\n                    message: 'Do you want to install node modules now? [yes/no]',\n                    validator: /y[es]*|n[o]?/,\n                    default: 'yes'\n                }], (errPrompt, rsPrompt) => {\n                    if (['yes', 'y'].indexOf(rsPrompt.installNow.toLowerCase()) > -1) {\n                        const cmdInstall = spawn('npm', ['i', '--loglevel=error'], { cwd: initPath });\n                        console.log(`Installing node modules in ${initPath}. Please wait...`);\n                        cmdInstall.stderr.on('data', data => console.error(data.toString()));\n                        cmdInstall.on('exit', code => {\n                            if (code === 0) {\n                                console.log('Installed'.help);\n                            }\n                            process.exit(code);\n                        });\n                    }\n                });\n            });\n        });\n    }\n\n    constructor() {\n    }\n\n    async config(options) {\n        let result = {};\n\n        if (!options.id && !options.secret && !options.token) {\n            return Promise.reject(new FLIFFError(FLIFF.ErrorMessages.ConfigRequiredIdSecretOrName));\n        } else {\n            result[FunctionsConfig.SingleChannelGroup] = {};\n        }\n\n        if (options.id) {\n            try {\n                await FunctionsConfig.set(`${FunctionsConfig.SingleChannelGroup}.${FunctionsConfig.ChannelIdName}`, options.id);\n                result[FunctionsConfig.SingleChannelGroup][FunctionsConfig.ChannelIdName] = options.id;\n            } catch (errId) {\n                return Promise.reject(errId);\n            }\n        }\n\n        if (options.secret) {\n            try {\n                await FunctionsConfig.set(`${FunctionsConfig.SingleChannelGroup}.${FunctionsConfig.ChannelSecretName}`, options.secret);\n                result[FunctionsConfig.SingleChannelGroup][FunctionsConfig.ChannelSecretName] = options.secret;\n            } catch (errSecret) {\n                return Promise.reject(errSecret);\n            }\n        }\n\n        if (options.token) {\n            try {\n                await FunctionsConfig.set(`${FunctionsConfig.SingleChannelGroup}.${FunctionsConfig.AccessTokenName}`, options.token);\n                result[FunctionsConfig.SingleChannelGroup][FunctionsConfig.AccessTokenName] = options.token;\n            } catch (errToken) {\n                return Promise.reject(errToken);\n            }\n        }\n\n        return result;\n    }\n\n    async update(options) {\n        const req = new LIFFUpdateRequest({ accessToken: FunctionsConfig.AccessToken });\n        let data = {};\n\n        if (!options.id && !options.name) {\n            return Promise.reject(new FLIFFError(FLIFF.ErrorMessages.UpdateRequiredIdOrName));\n        }\n\n        if (!options.id) {\n            options.id = await LIFFConfig.getViewIdByName(options.name, FunctionsConfig.config);\n            if (typeof options.id !== 'string') {\n                return Promise.reject(new FLIFFError(FLIFF.ErrorMessages.FailedToRetrieveIdUsingName));\n            }\n        }\n\n        if (!options.name) {\n            options.name = await LIFFConfig.getViewNameById(options.id, FunctionsConfig.config);\n            if (typeof options.name !== 'string') {\n                return Promise.reject(new FLIFFError(FLIFF.ErrorMessages.FailedToRetrieveNameUsingId));\n            }\n        }\n\n        if (options.type || options.url) {\n            data.view = {};\n            if (options.type) {\n                data.view.type = options.type;\n            }\n            if (options.url) {\n                data.view.url = options.url;\n            }\n        }\n\n        if (options.description) {\n            data.description = options.description;\n        }\n\n        if (options.ble) {\n            data.features = {\n                ble: (options.ble.toLowerCase() == 'false') ? false : true\n            };\n        }\n\n        try {\n            return await req.send(options.id, data);\n        } catch (error) {\n            if (error.response && error.response.data && error.response.data.message) {\n                return Promise.reject(error.response.data.message.error);\n            } else {\n                return Promise.reject(error);\n            }\n        }\n\n    }\n\n}\n"],"file":"fliff.js"}